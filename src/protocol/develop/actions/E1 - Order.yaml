#
# Order Action: Used by the administration to signal to the smart contract that the tokens that a particular public address(es) owns are to be confiscated, frozen, thawed or reconciled.
# F - Freeze tokens until freeze expires of thaw action reverses it.
# T - Thaw reverses a Freeze.
# C - Confiscate moves tokens from specified holders to a specified deposit address.
# R - Reconcile destroys tokens from specified holders to correct after a chain reorg has caused accidental creation of tokens.

code: E1
version: 1

metadata:
  name: Order
  label: Order
  description: >
    Used by the administration to signal to the smart contract that the tokens that a particular public address(es) owns are to be confiscated, frozen, thawed or reconciled.
  validation: AssetCreation
  rejection: Rejection

  inputs:
    - name: Administration
      label: "Administration's Public Address"
      comments: "This action can only come from the administration."

  outputs:
    - name: Contract
      label: Contract Public Address
      comments: "Contract fee and funding for response transaction."

fields:
  - name: ComplianceAction
    label: Compliance Action
    description: "Freeze (F), Thaw (T), Confiscate (C), Reconcile (R)"
    type: fixedchar
    size: 1
    example: "F"
    options:
      - 'F'
      - 'T'
      - 'C'
      - 'R'

  - name: AssetType
    label: Asset Type
    description: "Three letter character that specifies the asset type."
    type: fixedchar
    size: 3
    example: "SHC"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - F
      - C
      - R

  - name: AssetCode
    label: Asset Code
    description: A unique code that is used to identify the asset. It is generated by hashing the contract public key hash and the asset index. SHA256(contract PKH + asset index)
    type: AssetCode
    notes: "Cannot be changed by the administration, operator or smart contract."
    example: "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - F
      - C
      - R

  - name: TargetAddresses
    label: Target Addresses
    description: "The holders and quantities that are effected by the order. For a contract or asset wide freeze only the contract address is specified. Zero quantities are invalid unless it is for the contract address in an asset wide or contract wide freeze. In a thaw order this field is not serialized, because the entire freeze from the FreezeTxId freeze action will be thawed."
    type: TargetAddress[]
    # array size is number of bits to serialize the size of the array
    size: 2
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - F
      - C
      - R

  - name: FreezeTxId
    label: Freeze Tx Id
    description: "The tx id of the freeze action that is being thawed. Only serialized for thaw orders."
    type: TxId
    example: "74bc2ff786617f1bf861792421721d2a2ac9b78cac4dfec6c4d8dff9a6ded68d"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
        - T

  - name: FreezePeriod
    label: Freeze Period
    description: "Used for a 'time out'.  Tokens are automatically unfrozen after the expiration timestamp without requiring a Thaw Action. Null value for Thaw, Confiscation and Reconciallitaion orders."
    type: Timestamp
    example: "Tue Oct 09 2018 05:00:00 GMT+1000 (AEST)"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
        - F

  - name: DepositAddress
    label: Deposit Address
    description: "The public address for confiscated tokens to be deposited in.  Null for Freeze, Thaw, actions."
    type: PublicKeyHash
    notes: "Eventually the supporting evidence/explanation can be supported by a Subfield that has the public address (and a signed message) owned by a legal authority for ID verification/certification purposes."
    example: "5afe5ca1ab1e5e771eab1eca5cadab1eda7aba5e"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
        - C

  - name: AuthorityIncluded
    label: Authority Included
    description: "Specifies if an authority signature is included. For Reconcialitaion actions all authority signature related fields are skipped during serialization."
    type: bool
    example: true
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - F
      - T
      - C

  - name: AuthorityName
    label: Authority Name
    description: "Length 0-255 bytes. Enforcement Authority Name (eg. Issuer, Queensland Police Service, Tokenized, etc.)"
    type: varchar
    # varchar size is number of bytes to serialize the size of the value
    size: 1
    example: "Supreme and District Courts Brisbane"
    includeIfTrue: AuthorityIncluded

  - name: AuthorityPublicKey
    label: Authority Public Key
    description: "Length 0-255 bytes. Public Key associated with the Enforcement Authority"
    type: varbin
    # varbin size is number of bytes to serialize the size of the data
    # TODO: Make this a fixed-length compressed public key type.
    size: 1
    example: "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f2021"
    includeIfTrue: AuthorityIncluded

  - name: SignatureAlgorithm
    label: Signature Algorithm
    description: "Algorithm used for order signature. Only valid value is currently 1 = ECDSA+secp256k1"
    type: uint
    size: 1
    example: 1
    includeIfTrue: AuthorityIncluded
    intValues:
      - 1

  - name: OrderSignature
    label: Authority Order Signature
    description: "Length 0-255 bytes. Signature for a message that lists out the target addresses and deposit address. Signature of (Contract PKH, Compliance Action, Authority Name, Asset Code, Supporting Evidence Hash, FreezePeriod, TargetAddresses, and DepositAddress)"
    type: varbin
    # varbin size is number of bytes to serialize the size of the value
    size: 1
    example: "1fa743904ad9c0bd5c5f457ffae9d897cd3bbbb3625cca639e6e48951966c0e4865ee0fbad730a82be1a986940440bef2b159ae0029494b95d114d846ac3b8d6aa"
    includeIfTrue: AuthorityIncluded

  - name: SupportingEvidenceHash
    label: Supporting Evidence Hash
    description: "SHA-256: warrant, court order, etc."
    type: bin
    size: 32
    example: "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f20"

  - name: RefTxs
    label: Ref Txs
    description: "The request/response actions that were dropped.  The entire txn for both actions is included as evidence that the actions were accepted into the mempool at one point and that the senders (token/Bitcoin) signed their intent to transfer.  The management of this record keeping is off-chain and managed by the administration or operator to preserve the integrity of the state of the tokens. Only applicable for reconcilliation actions.  No subfield when F, T, R is selected as the Compliance Action subfield."
    type: varbin
    size: 4
    notes: "Can be null.  Dropped actions that require a reconciliation action to fix the break in the chain are considered to be an extremely rare event."
    example: "01000000036a569bf7775331d68bd4f95b0d8c583f9d67927cf054a1fd015215683323a8f010000006bd83045022100f8decf58f1411683bc4207f3f07c32d2bbfbe342562c50af18582248aecbf9b4022038b6e7d86bd8e256337662cf377b0885a779eb4fe3b9748c4d8dbd91393b7ed84121035ee01a014b2834743f182b96285289f64196769881ebf4f428c60465e84fd669fefffffff3c52f9e78377cacd88a0f008a3b4b839a17504a4f9851cbf217d9f1621e8a94010000006a473044022025dbc4b33ced2ffc4e6c494689f53bbe45f28b1d93868419422dca16582e20f402202c2820670421d0655216d0a096b3c0096b919579a65d81ae51c9c37150bf26634121035ee01a014b2834743f182b96285289f64196769881ebf4f428c60465e84fd669feffffffcb9696041cf2684cec74710e93522fa363bd3f666f79a1ae45de8e49a484e69c000000006a473044022063fbdafe29d69cd838f9c5881f0f25b4cd7ca92cb4b616fb92f6018c7e2ed0730220051e90ff3f8cd2dff0a2fd687f433532f0114216c74782ba7fc6675bed4ad7ba4121035ee01a014b2834743f182b96285289f64196769881ebf4f428c60465e84fd669feffffff0200a89c13460200001976a9144c53b4336ae1ad17122a0f425fd2689552dd107388ac58a15159c70200001976a914eb248bdc12a70ac423a00ba870a9f0f5c438dc6c88ac2b130900"
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - R

  - name: BitcoinDispersions
    label: Bitcoin Dispersions
    description: "Index of address in TargetAddresses and amount of bitcoin (in satoshis) they are receiving in exchange for their tokens."
    type: QuantityIndex[]
    # array size is number of bits to serialize the size of the array
    size: 2
    # includeIf specifies that this field is only included in serialization if the specified field has one of the specified values.
    includeIf:
      field: ComplianceAction
      values:
      - R

  - name: Message
    label: Message
    description: "A message to include with the enforcement order."
    type: varchar
    # varchar size is number of bytes to serialize the size of the value
    size: 4
    example: "Compelled by a court order."
